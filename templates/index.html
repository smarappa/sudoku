<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sudoku Game</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="game-container">
        <h1 class="game-title">Sudoku</h1>
        <div class="game-info">
            <div class="info-card"><div class="info-label">Difficulty</div><div class="info-value" id="difficulty">Medium</div></div>
            <div class="info-card"><div class="info-label">Timer</div><div class="info-value" id="timer">00:00</div></div>
            <div class="info-card"><div class="info-label">Mistakes</div><div class="info-value" id="mistakes">0</div></div>
            <div class="info-card"><div class="info-label">Progress</div><div class="info-value" id="progress">0%</div></div>
        </div>
        <div class="sudoku-board" id="sudoku-board"></div>
        <div class="number-pad">
            <button class="number-btn" data-number="1">1</button>
            <button class="number-btn" data-number="2">2</button>
            <button class="number-btn" data-number="3">3</button>
            <button class="number-btn" data-number="4">4</button>
            <button class="number-btn" data-number="5">5</button>
            <button class="number-btn" data-number="6">6</button>
            <button class="number-btn" data-number="7">7</button>
            <button class="number-btn" data-number="8">8</button>
            <button class="number-btn" data-number="9">9</button>
            <button class="number-btn clear-btn" data-number="clear">Clear</button>
        </div>
    </div>

    <script>
        class SudokuGame {
            constructor() {
                this.board = []; this.solution = []; this.selectedCell = null; this.mistakes = 0;
                this.startTime = Date.now(); this.timer = null;
                this.init();
            }
            
            async init() {
                this.initBoard();
                await this.loadPuzzle();
                this.startTimer();
                this.bindEvents();
            }
            
            initBoard() {
                const board = document.getElementById('sudoku-board');
                board.innerHTML = '';
                for (let i = 0; i < 81; i++) {
                    const cell = document.createElement('input');
                    cell.className = 'sudoku-cell';
                    cell.type = 'text'; cell.maxLength = 1; cell.dataset.index = i;
                    board.appendChild(cell);
                }
            }
            
            async loadPuzzle() {
                const response = await fetch('/api/puzzle');
                const data = await response.json();
                this.board = data.puzzle; this.solution = data.solution;
                this.renderBoard();
            }
            
            renderBoard() {
                document.querySelectorAll('.sudoku-cell').forEach((cell, i) => {
                    const row = Math.floor(i / 9), col = i % 9, val = this.board[row][col];
                    cell.value = val === 0 ? '' : val;
                    cell.className = 'sudoku-cell';
                    if (val !== 0) { cell.classList.add('prefilled'); cell.readOnly = true; }
                });
                this.updateProgress();
            }
            
            bindEvents() {
                document.querySelectorAll('.sudoku-cell').forEach(cell => {
                    cell.addEventListener('click', e => this.selectCell(e.target));
                    cell.addEventListener('input', e => this.handleInput(e));
                });
                document.querySelectorAll('.number-btn').forEach(btn => {
                    btn.addEventListener('click', e => this.handleNumberPad(e));
                });
            }
            
            selectCell(cell) {
                if (cell.readOnly) return;
                document.querySelectorAll('.sudoku-cell').forEach(c => c.classList.remove('selected'));
                cell.classList.add('selected'); this.selectedCell = cell;
            }
            
            async handleInput(e) {
                const val = e.target.value;
                if (!/^[1-9]$/.test(val)) { e.target.value = ''; return; }
                const i = parseInt(e.target.dataset.index);
                const row = Math.floor(i / 9), col = i % 9;
                await this.makeMove(row, col, parseInt(val), e.target);
            }
            
            async handleNumberPad(e) {
                if (!this.selectedCell) return;
                const num = e.target.dataset.number;
                if (num === 'clear') { this.clearCell(this.selectedCell); return; }
                const i = parseInt(this.selectedCell.dataset.index);
                const row = Math.floor(i / 9), col = i % 9;
                await this.makeMove(row, col, parseInt(num), this.selectedCell);
            }
            
            async makeMove(row, col, num, cell) {
                const response = await fetch('/api/validate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({row, col, num, solution: this.solution})
                });
                const {valid} = await response.json();
                
                if (valid) {
                    this.board[row][col] = num; cell.value = num;
                    cell.classList.add('valid');
                    setTimeout(() => cell.classList.remove('valid'), 300);
                } else {
                    this.mistakes++;
                    document.getElementById('mistakes').textContent = this.mistakes;
                    cell.classList.add('invalid');
                    setTimeout(() => {
                        cell.classList.remove('invalid');
                        cell.value = '';
                    }, 500);
                }
                this.updateProgress();
            }
            
            clearCell(cell) {
                if (cell.readOnly) return;
                const i = parseInt(cell.dataset.index);
                const row = Math.floor(i / 9), col = i % 9;
                this.board[row][col] = 0; cell.value = '';
                this.updateProgress();
            }
            
            updateProgress() {
                const filled = this.board.flat().filter(c => c !== 0).length;
                document.getElementById('progress').textContent = `${Math.round((filled / 81) * 100)}%`;
            }
            
            startTimer() {
                this.timer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                    const min = Math.floor(elapsed / 60).toString().padStart(2, '0');
                    const sec = (elapsed % 60).toString().padStart(2, '0');
                    document.getElementById('timer').textContent = `${min}:${sec}`;
                }, 1000);
            }
        }
        
        new SudokuGame();
    </script>
</body>
</html>